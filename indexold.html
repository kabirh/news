<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>News</title>
    <link rel="stylesheet" href="sp://import/css/eve.css">
    <script type="text/javascript" src="js/jquery.min.js"></script>
</head>

<body>
<h2>See the latest news for the artists you love</h2>
<div id="info"> </div>
  <button id="new" onclick="fetchNewsFromNowPlaying()"> Find News </button>
  <div id='all-results'>
    <ul id="results"> </ul>
  </div>
</body>

<script type="text/javascript">

sp = getSpotifyApi(1);
jQuery.ajaxSettings.traditional = true;  


function fetchNewsFromNowPlaying() {
    var playerTrackInfo = sp.trackPlayer.getNowPlayingTrack();
    console.log(playerTrackInfo);

    if (playerTrackInfo == null) {
        info("Start playing something and I'll find you news from the artist.");
    } else {
        var track = playerTrackInfo.track;
        var artist = track.artists[0].name;
        fetchNews(artist, 1);
    }
}

function fetchNews(artist, size) {
    info('Getting news for ' + artist);
    var url = 'http://developer.echonest.com/api/v4/artist/news?api_key=P5UNONUVKBUYT1EIZ&callback=?';

    $.getJSON(url, { 'name': artist, 'format':'jsonp', 
            'results': size, 'start':'0', 'high_relevance': 'true'}, function(data) {
        if (checkResponse(data)) {
            $("#results").empty();
            info("");
            var curTracks = []
            for (var i = 0; i < data.response.news.length; i++) {
                var news = data.response.news[i];
                var newsfeed = news.name + " on " + news.url;
		console.log(newsfeed);
                var li = $("<li>").text("<a href="+news.url+">"+news.name+"</a>");
                $("#results").append(li);
            }
        } else {
            info("trouble getting results");
        }
    });
}

function info(s) {
    $("#info").text(s);
}

function error(s) {
    info(s);
}

function checkResponse(data) {
    if (data.response) {
        if (data.response.status.code != 0) {
            error("Whoops... Unexpected error from server. " + data.response.status.message);
            log(JSON.stringify(data.response));
        } else {
            return true;
        }
    } else {
        error("Unexpected response from server");
    }
    return false;
}

$(document).ready(function() {
    fetchNewsFromNowPlaying();
});

</script>

</html>
